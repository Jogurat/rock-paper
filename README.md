## FastAPI RPSLS Service

FastAPI service for Rock–Paper–Scissors–Lizard–Spock with basic matchmaking backed by Postgres and Redis.

### Prerequisites

- Docker engine (v28.3.2) and Docker Compose (v2.38.2)
- [uv](https://docs.astral.sh/uv/) (v0.8.5)

### Quick start

1. Create a `.env` file from the provided `.env.example` file

2. Build and start the stack

```bash
docker compose up -d --build
```

3. Services

- API: `http://localhost:8000`
- API docs:
  - Swagger: `http://localhost:8000/docs`
  - Redoc: `http://localhost:8000/redoc`
- Adminer (DB UI): `http://localhost:8080`

4. Stop the stack

```bash
docker compose down
```

### Adminer

Adminer is a simple database manipulation tool, think of it as a simpler version of phpmyadmin. You can use it to view the database.

Make sure you use the Postgres connection type, as well as the username/password from `.env` - defaulted to username: `postgres` and password: `rockpaper`

## Using the API

Although FastAPI generates Swagger/Redoc documentation for us automatically, there is also a [Hoppscotch](https://hoppscotch.io/) collection for exploring the API, located in `hoppscotch-collection.json`.

Hoppscotch is a Postman-like API client which can be used for just about anything that Postman can (without downloading or logging in even! :) )

A simple use-case might look something like:

- Create a couple of users
- Enter matchmaking (enqueue) with at least two of them
- Grab their `match_id`s from the matchmaking tickets
- Play moves with both players
- Check the leaderboard

Notes:

- A background job runs every ~3 seconds and pairs two queued players, creating a match and updating their ticket status to `matched` with a `match_id`. The matchmaking takes into account an arbitrary score when selecting players to match, using redis sorted sets.

- The leaderboard represents the LATEST 10 matches across the entire service.

## Migrations

Migrations are done using [Alembic](https://alembic.sqlalchemy.org/en/.latest/#).
The database schema is initialized automatically via SQL in `migrations/versions/init.sql` on first run. This script has been generated by alembic. If needed, new migrations can be created by running:

```bash
uv sync
uv run alembic revision --autogenerate -m '<message>'
```

and, finally, running the migration(s) itself:

```bash
uv run alembic upgrade head
```

## Testing

The tests are separated into e2e (end-to-end) and unit tests under the `tests/` suvdirectory.

You can run the tests with

```bash
uv run pytest
```

## Linting/Formatting

For linting, we are using [Ruff](https://docs.astral.sh/ruff/).

You can run it the following command:

```bash
uv run ruff check .
```

Ruff also provides plugins for editors, which can be configured to format files upon save.
